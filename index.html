<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8ë²ˆ ì°¨ì›</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
    @font-face { 
        font-family: 'ONE-Mobile-POP'; 
        src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2105_2@1.0/ONE-Mobile-POP.woff') format('woff'); 
    }
    body { 
        font-family: 'ONE-Mobile-POP', sans-serif; 
        background-color: #2c3e50; 
        background-image: radial-gradient(#34495e 15%, transparent 16%), radial-gradient(#34495e 15%, transparent 16%);
        background-size: 60px 60px;
        background-position: 0 0, 30px 30px;
        color: #fff; text-align: center; margin: 0; padding: 0; 
        display: flex; justify-content: center; align-items: center; height: 100vh; user-select: none;
    }

    #game-container { 
        width: 95vw; max-width: 900px; height: 90vh; max-height: 720px;
        background-color: #fffdf7; color: #333;
        border: 8px solid #f39c12; border-radius: 20px; position: relative; 
        overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 15px 30px rgba(0,0,0,0.5);
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
      20%, 40%, 60%, 80% { transform: translateX(8px); }
    }
    .shake-effect { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }

    .screen { 
        display: none; width: 100%; height: 100%; flex-direction: column; 
        justify-content: center; align-items: center; position: absolute; 
        top: 0; left: 0; animation: fadeIn 0.3s ease-in-out; padding: 20px; box-sizing: border-box;
    }
    .active { display: flex; }
    @keyframes imageFadeIn {
        from { opacity: 0; transform: scale(0.98); }
        to { opacity: 1; transform: scale(1); }
    }
    .fade-in-effect {
        animation: imageFadeIn 0.5s ease-out;
    }
    .score-board { 
        position: absolute; top: 20px; left: 20px; font-size: 24px; color: #fff; 
        background: #e67e22; padding: 8px 20px; border-radius: 30px; z-index: 10; border: 3px solid #d35400;
        display: none; 
    }

    .btn-skip {
        position: absolute;
        top: 20px;
        right: 20px;
        background-color: #7f8c8d;
        border-bottom: 5px solid #636e72;
        padding: 12px 26px;
        font-size: 22px;   
        font-family: 'ONE-Mobile-POP', sans-serif;
        color: white;
        border-radius: 25px;
        z-index: 20;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .btn-skip:hover { background-color: #95a5a6; transform: translateY(-3px); }
    .btn-skip:active { transform: translateY(2px); }
    
    .char-image-container { 
        width: 90%; max-width: 400px; 
        aspect-ratio: 1 / 1; flex-shrink: 0;
        background-color: #ecf0f1; display: flex; 
        justify-content: center; align-items: center; margin-bottom: 15px; 
        border: 6px solid #bdc3c7; border-radius: 20px; overflow: hidden;
        position: relative; 
    }
    .char-image-container img { width: 100%; height: 100%; object-fit: contain; }
    
    .name-overlay {
        position: absolute; top: 10px; left: 10px; 
        background: rgba(0, 0, 0, 0.6); color: #fff; 
        padding: 8px 15px; border-radius: 15px; font-size: 25px;
        font-weight: normal; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        white-space: nowrap; z-index: 5;
    }

    .stats-overlay {
        position: absolute; bottom: 10px; right: 10px;
        background: rgba(0, 0, 0, 0.7); color: #fff;
        padding: 6px 12px; border-radius: 12px; font-size: 14px;
        text-align: right; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        z-index: 5;
    }

    .speech-box {
        width: 90%; max-width: 500px; min-height: 40px; background: rgba(255, 255, 255, 0.95);
        color: #2c3e50; border-radius: 12px; padding: 12px 20px; margin-bottom: 15px;
        border: 4px solid #34495e; box-shadow: 4px 4px 0px rgba(52, 73, 94, 0.1);
        display: flex; justify-content: center; align-items: center; font-size: 18px;
    }
/* ğŸ‘‡ ì´ ë¶€ë¶„ì„ ìƒˆë¡œ ì¶”ê°€í•´ ì£¼ì„¸ìš” ğŸ‘‡ */
    .speech-box p {
        white-space: pre-wrap; /* \n ê¸°í˜¸ë¥¼ ì‹¤ì œ ì¤„ë°”ê¿ˆìœ¼ë¡œ ì¸ì‹í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤ */
        margin: 0; 
        line-height: 1.4; /* ì¤„ ê°„ê²©ë„ ì‚´ì§ ë„“í˜€ì„œ ë³´ê¸° ì¢‹ê²Œ */
    }

    button { 
        padding: 15px 40px; font-size: 20px; font-family: 'ONE-Mobile-POP', sans-serif;
        cursor: pointer; border: none; border-radius: 50px; 
        transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        box-shadow: 0 8px 0px rgba(0,0,0,0.15); 
        color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        display: inline-flex; align-items: center; justify-content: center; outline: none;
    }
    button:hover { transform: translateY(-5px); box-shadow: 0 13px 0px rgba(0,0,0,0.1); }
    button:active { transform: translateY(5px); box-shadow: 0 2px 0px rgba(0,0,0,0.2); }

    .btn-group { display: flex; gap: 15px; justify-content: center; }
    .btn-real { background-color: #2ecc71; border-bottom: 4px solid #27ae60; }
    .btn-fake { background-color: #e74c3c; border-bottom: 4px solid #c0392b; }
    .btn-move { background-color: #3498db; border-bottom: 4px solid #2980b9; padding: 18px 50px; }
    .btn-close { background-color: #7f8c8d; border-bottom: 4px solid #636e72; padding: 12px 24px; font-size: 16px; margin-top: 15px; }

    #waiting-list-panel {
        transition: all 0.3s ease; overflow-y: auto;
        scrollbar-width: none; -ms-overflow-style: none;
        display: flex; flex-direction: column; align-items: center;
    }
    #waiting-list-panel::-webkit-scrollbar { display: none; }
    
    #waiting-list-panel.full-view {
        width: 100%; justify-content: flex-start;
    }
    
    #filter-container {
        display: flex; flex-wrap: wrap; justify-content: center; 
        gap: 6px; width: 100%; padding: 15px 10px 5px 10px; max-width: 600px;
        box-sizing: border-box; flex-shrink: 0;
    }
    
    #waiting-list-panel.detail-view #filter-container {
        padding: 10px 5px; max-width: 100%;
    }

    .filter-btn {
        width: 30px; height: 30px; border-radius: 50%;
        border: 2px solid #bdc3c7; background-color: #ecf0f1;
        color: #2c3e50; font-family: 'ONE-Mobile-POP', sans-serif;
        font-size: 13px; cursor: pointer; transition: all 0.2s;
        display: flex; justify-content: center; align-items: center;
        padding: 0; flex-shrink: 0; box-shadow: 0 3px 0px rgba(0,0,0,0.1);
    }
    .filter-btn.all-btn { width: auto; padding: 0 12px; border-radius: 15px; }
    .filter-btn:hover { background-color: #f39c12; color: white; border-color: #d35400; transform: translateY(-2px); }
    .filter-btn.active { background-color: #e67e22; color: white; border-color: #d35400; transform: translateY(2px); box-shadow: 0 1px 0px rgba(0,0,0,0.1); }

    #waiting-chars {
        display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; padding: 10px; width: 100%; box-sizing: border-box;
    }

    #waiting-list-panel.detail-view {
        width: 170px; border-left: 4px dashed #bdc3c7; padding: 0; cursor: grab;
    }
    #waiting-list-panel.detail-view:active { cursor: grabbing; }
    #waiting-list-panel.detail-view #waiting-chars {
        display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; justify-items: center; padding-top: 5px;
    }

    .waiting-char { 
        width: 65px; height: 65px; background-color: #fff; border-radius: 50%; 
        cursor: pointer; overflow: hidden; border: 4px solid #bdc3c7; transition: transform 0.2s; flex-shrink: 0;
    }
    .waiting-char:hover { transform: scale(1.1); }
    .waiting-char img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
    .waiting-char.correct { border-color: #2ecc71; }
    .waiting-char.wrong { border-color: #e74c3c; }
    .waiting-char.unattempted { border-color: #95a5a6; filter: grayscale(100%); opacity: 0.6; }

    .detail-layout { display: flex; flex-direction: row; align-items: stretch; justify-content: center; width: 100%; max-width: 550px; }
    .vertical-nav { display: flex; flex-direction: column; gap: 12px; justify-content: center; padding-right: 15px; }
    .nav-btn {
        padding: 12px 20px; font-size: 18px; border: none; border-radius: 12px; cursor: pointer;
        font-family: 'ONE-Mobile-POP', sans-serif; transition: all 0.2s; background: #95a5a6; color: white;
        border-bottom: 4px solid #7f8c8d; box-shadow: none;
    }
    .nav-btn.active { background: #f39c12; border-bottom: 4px solid #d35400; transform: scale(1.05); }
    .nav-btn:hover:not(.active) { background: #bdc3c7; transform: translateY(-2px); }

    @media (max-width: 600px) {
        #waiting-list-panel.detail-view { width: 130px; }
        .waiting-char { width: 50px; height: 50px; }
        h3 { margin: 5px 0; font-size: 20px !important; }
        .name-overlay { font-size: 16px; padding: 6px 12px; top: 8px; left: 8px; } 
        .btn-move { padding: 12px 30px; font-size: 16px; }
        .detail-layout { flex-direction: column; align-items: center; }
        .vertical-nav { flex-direction: row; padding-right: 0; padding-bottom: 15px; }
        .nav-btn { padding: 8px 15px; font-size: 16px; }
    }

    #loading-container { width: 80%; height: 24px; background-color: #ecf0f1; border-radius: 12px; margin-top: 20px; border: 3px solid #34495e; overflow: hidden; }
    #loading-bar { width: 0%; height: 100%; background-color: #f1c40f; transition: width 0.3s ease-out; }
    .result-title { font-size: 32px; margin-bottom: 5px; margin-top: 30px; transition: color 0.3s; }
    .result-correct { color: #27ae60; }
    .result-wrong { color: #c0392b; }
    .result-question { color: #3498db; }

    /* íŠ¹ìˆ˜ ì”¬: ìºë¦­í„° ìŠ¤í¬ë¡¤ ì„¤ì • */
    #ending-slide-container {
        display: none;
        width: 100%;
        height: 100%;
        overflow: hidden;
        position: relative;
        align-items: center;
        justify-content: flex-start;
    }
    
    #ending-slide-track {
        display: flex;
        align-items: center;
        height: 100%;
        /* width: max-contentê°€ í•µì‹¬ì…ë‹ˆë‹¤. ì˜ë¦¼ ë°©ì§€ */
        width: max-content; 
    }
    
/* íŠ¹ìˆ˜ ì”¬: ìºë¦­í„° ìŠ¤í¬ë¡¤ ì„¤ì • */
    #ending-slide-container {
        display: none;
        width: 100%;
        height: 100%;
        overflow: hidden;
        position: relative;
        align-items: center;
        justify-content: flex-start;
    }
    
    #ending-slide-track {
        display: flex;
        align-items: center;
        height: 100%;
        width: max-content; 
    }
    
    /* ìŠ¬ë¼ì´ë“œ ì•„ì´í…œì„ ê°ì‹¸ëŠ” ìƒì (ìƒˆë¡œ ì¶”ê°€ë¨) */
    .slide-item {
        position: relative;
        height: 70%;
        aspect-ratio: 1 / 1;
        margin: 0 15px;
        flex-shrink: 0;
        border-radius: 15px;
        border: 4px solid #bdc3c7;
        background-color: #fff;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    /* ìƒì ì•ˆì˜ ì´ë¯¸ì§€ */
    .slide-item img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
</style>
</head>
<body>

<div id="game-container">
    <div class="score-board">í˜„ì¬ ì°¨ì›: <span id="score">0</span> / 8</div>

    <div id="screen-loading" class="screen active">
        <h2 id="loading-text" style="color: #34495e; font-size: 28px;">ë³¼ë”°êµ¬ ì „ìˆ˜ ì¡°ì‚¬ ì¤‘... (0%)</h2>
        <div id="loading-container"><div id="loading-bar"></div></div>
    </div>

    <div id="screen-intro" class="screen">
        <button class="btn-skip" onclick="skipIntro()">ìŠ¤í‚µ â­</button>
        
        <div class="char-image-container" style="margin-top: 30px;">
            <img id="intro-image" src="">
            <div id="intro-name-overlay" class="name-overlay"></div>
        </div>
        <div class="speech-box"><p id="intro-dialogue-text"></p></div>
        
        <div class="btn-group">
            <button class="btn-move" onclick="nextIntro()">ë‹¤ìŒ â–¶</button>
        </div>
    </div>

    <div id="screen-waiting" class="screen" style="padding: 0;">
        <div id="waiting-header" style="width: 100%; display: flex; flex-direction: column; align-items: center; padding-top: 20px;">
            <h2 style="margin-bottom: 10px; font-size: 32px;">ëŒ€ê¸°ì‹¤</h2>
        </div>

        <div style="width: 100%; flex: 1; display: flex; flex-direction: row; overflow: hidden; justify-content: center; position: relative;">
            
            <div id="waiting-detail-left" style="display: none; flex: 1; flex-direction: column; align-items: center; justify-content: center; padding: 10px;">
                
                <div class="detail-layout">
                    <div class="vertical-nav">
                        <button class="nav-btn" id="nav-btn-q" onclick="changeDetailView('question')">ë¬¸ì œ</button>
                        <button class="nav-btn" id="nav-btn-o" onclick="changeDetailView('correct')">ì •ë‹µ</button>
                        <button class="nav-btn" id="nav-btn-x" onclick="changeDetailView('wrong')">ì˜¤ë‹µ</button>
                    </div>

                    <div id="waiting-dialogue-box" style="display: flex; flex-direction: column; align-items: center; background: #fffdf7; border: 4px solid #34495e; border-radius: 20px; padding: 15px; width: 100%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                        <div id="waiting-result-header" class="result-title" style="font-size: 22px; margin-top:0; margin-bottom: 15px;"></div>
                        
                        <div class="char-image-container">
                            <img id="waiting-char-image" src="">
                            <div id="waiting-name-overlay" class="name-overlay"></div>
                            <div id="waiting-stats-overlay" class="stats-overlay" style="display: none;"></div>
                        </div>

                        <div class="speech-box" style="width: 95%; min-height: 30px; font-size: 16px; margin-bottom: 5px;">
                            <p id="waiting-dialogue-text"></p>
                        </div>
                    </div>
                </div>
                
                <button class="btn-close" onclick="closeWaitingDetail()">âŒ ëŒì•„ê°€ê¸°</button>
            </div>

            <div id="waiting-list-panel" class="full-view">
                <div id="filter-container"></div>
                <div id="waiting-chars"></div>
            </div>
        </div>

        <div id="waiting-footer" style="padding-bottom: 30px;">
            <button class="btn-move" onclick="moveToQuestion()">ë‹¤ìŒ ì°¨ì›ìœ¼ë¡œ ì´ë™</button>
        </div>
    </div>

    <div id="screen-question" class="screen">
        <div class="char-image-container" style="margin-top: 30px;">
            <img id="question-image" src="">
            <div id="question-name-overlay" class="name-overlay"></div>
        </div>
        <div class="speech-box"><p id="question-dialogue-text"></p></div>
        <div class="btn-group">
            <button class="btn-real" onclick="submitAnswer(true)">O ì§„ì§œë‹¤</button>
            <button class="btn-fake" onclick="submitAnswer(false)">X ê°€ì§œë‹¤</button>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <div id="result-heading" class="result-title" style="margin-top: 0; margin-bottom: 20px;">ì •ë‹µ ì—¬ë¶€</div>
        <div class="char-image-container">
            <img id="result-image" src="">
            <div id="result-name-overlay" class="name-overlay"></div>
            <div id="result-stats-overlay" class="stats-overlay">
                í†µê³„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
        </div>

        <div class="speech-box"><p id="result-speech-text"></p></div>
        
        <button class="btn-move" onclick="closeResultAndMove()">ê³„ì†í•˜ê¸°</button>
    </div>

    <div id="screen-ending" class="screen">
        <div class="char-image-container" style="margin-top: 30px; position: relative;">
            <img id="ending-single-image" src="" class="fade-in-effect">
            
            <div id="ending-slide-container">
                <div id="ending-slide-track"></div>
            </div>
            
            <div id="ending-name-overlay" class="name-overlay"></div>
        </div>
        <div class="speech-box"><p id="ending-dialogue-text"></p></div>
        
        <div id="ending-btn-next-container" class="btn-group">
            <button class="btn-move" onclick="nextEnding()">ë‹¤ìŒ â–¶</button>
        </div>
        <div id="ending-btn-choice-container" class="btn-group" style="display: none;">
            <button class="btn-real" onclick="chooseEnding(true)">O ì§„ì§œë‹¤</button>
            <button class="btn-fake" onclick="chooseEnding(false)">X ê°€ì§œë‹¤</button>
        </div>
    </div>

    <div id="screen-thanks" class="screen">
        <h1 style="color: #f1c40f; font-size: 50px;">í”Œë ˆì´í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤!</h1>
        <button class="btn-move" style="margin-top: 20px;" onclick="resetGame()">ì²˜ìŒë¶€í„° ë‹¤ì‹œ í•˜ê¸°</button>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, increment, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB5lHhwpQgyPqzLRkUBa0ROkNxKVLAG-Y8",
      authDomain: "exit-bol.firebaseapp.com",
      projectId: "exit-bol",
      storageBucket: "exit-bol.firebasestorage.app",
      messagingSenderId: "259374629685",
      appId: "1:259374629685:web:56bdb417ef6269c1b5827c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.popConfetti = () => {
        if (typeof confetti === 'function') {
            confetti({ 
                particleCount: 100, 
                spread: 70, 
                origin: { y: 0.6 }, 
                colors: ['#2ecc71', '#f1c40f', '#ffffff'],
                ticks: 120  
            });
        }
    };

    let CHARACTERS = [];
    let score = 0;
    let playerProgress = JSON.parse(localStorage.getItem('trickcal_progress')) || {}; 
    let remainingPool = []; 
    let currentProblem = null;
    let lastResultStatus = false;
    let isDraggingList = false;
    let currentDetailChar = null;
    let currentFilter = 'All'; 
    let currentRunHistory = []; 

    const introStory = [
        { name: "???", img: "./images/intro0.webp", text: "â€¦êµâ€¦" },
        { name: "???", img: "./images/intro1.webp", text: "â€¦êµâ€¦ì£¼â€¦" },
        { name: "???", img: "./images/intro2.webp", text: "êµâ€¦â€¦ì£¼â€¦â€¦ë‹˜â€¦â€¦!" },
        { name: "ë¦´ë¦¬", img: "./images/intro3.webp", text: "êµì£¼ë‹˜! ì¼ì–´ë‚˜ì„¸ìš”!" },
        { name: "êµì£¼", img: "./images/intro4.webp", text: "(ë‚¯ì„  ì²œì¥ì´ë‹¤â€¦)" },
        { name: "êµì£¼", img: "./images/intro4.webp", text: "(ì—¬ê¸°ê°€â€¦ ì–´ë””ì˜¤â€¦?)" },
        { name: "ë¦´ë¦¬", img: "./images/intro3.webp", text: "ì£¼ë§ë†ì¥ì€ ì•„ë‹ˆë‹ˆê¹Œ ì•ˆì‹¬í•˜ì„¸ìš”" },
        { name: "ë¦´ë¦¬(ì„¤ëª…)", img: "./images/intro4.webp", text: "ì´ê³³ì€ ì°¨ì›ê³¼ ì°¨ì›ì˜ í‹ˆìƒˆ" },
        { name: "ë¦´ë¦¬", img: "./images/intro3.webp", text: "êµì£¼ë‹˜ê»˜ì„  í”„ë¡ í‹°ì–´ í™œë™ ì¤‘ì— ì‚¬ê³ ë¡œ ì´ê³³ì— ë–¨ì–´ì§€ì…¨ì–´ìš”" },
        { name: "êµì£¼", img: "./images/intro4.webp", text: "(ì›ë˜ì˜ ì„¸ê³„ë¡œ ëŒì•„ê°€ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼í•˜ì§€?)" },
        { name: "ë¦´ë¦¬", img: "./images/intro3.webp", text: "êµì£¼ë‹˜ê»˜ ë‚¨ì•„ìˆëŠ” ë§ˆë ¥ì˜ í”ì ì„ ì¶”ì í•´ì„œ ì›ë˜ ì°¨ì›ì„ ì¶”ì í•˜ê³  ìˆì–´ìš”" },
        { name: "ë¦´ë¦¬", img: "./images/intro3.webp", text: "ë¬´í•œí•œ ì°¨ì› ì†ì—ì„œ ê°€ëŠ¥ì„±ì´ ë†’ì€ ì°¨ì›ì„ ìµœëŒ€í•œìœ¼ë¡œ ì„ ë³„í•´ë´¤ì§€ë§Œ" },
        { name: "ë¦´ë¦¬", img: "./images/intro5.webp", text: "200ê°œ ë¯¸ë§Œìœ¼ë¡œ ì¤„ì´ëŠ” ê²Œ í•œê³„ì˜€ì–´ìš”" },
        { name: "ë¦´ë¦¬", img: "./images/intro5.webp", text: "ê·¸ë˜ì„œ êµì£¼ë‹˜ì˜ ë„ì›€ì´ í•„ìš”í•´ìš”!"},
        { name: "ë¦´ë¦¬", img: "./images/intro6.webp", text: "ì—¬ëŸ¬ ì°¨ì›ì˜ ì‚¬ë„ë“¤ì„ ë³´ì—¬ë“œë¦´í…Œë‹ˆ ì•Œë§ì€ ì‚¬ë„ë¥¼ ê³¨ë¼ì£¼ì„¸ìš”" },
        { name: "ë¦´ë¦¬(ìˆ˜í•™)", img: "./images/intro7.webp", text: "8ë²ˆë§Œ ì •í™•í•˜ê²Œ ê³¨ë¼ì£¼ì‹œë©´ êµì£¼ë‹˜ì˜ ì°¨ì›ì„ ì„ ë³„í•  ìˆ˜ ìˆì–´ìš”" },
        { name: "ë¦´ë¦¬", img: "./images/intro6.webp", text: "ë‹¤ë§Œ ì¤‘ê°„ì— í•œ ë²ˆì´ë¼ë„ í‹€ë¦¬ë©´ ë‹¤ì‹œ ì²˜ìŒë¶€í„° ì‹œì‘í•´ì•¼í•´ìš”" },
        { name: "ë¦´ë¦¬", img: "./images/intro3.webp", text: "ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤, ë‚¨ì•„ìˆëŠ” ë§ˆë ¥ì´ ì‚¬ë¼ì§€ê¸° ì „ì— ì„œë‘ë¥´ì„¸ìš”!" },
        { name: "ë¦´ë¦¬", img: "./images/intro5.webp", text: "ì°¸ê³ ë¡œ ì‚¬ë„ë“¤ì€ ë•Œë•Œë¡œ ì œ 4ì˜ ë²½ì„ ë„˜ê¸°ë„ í•œë‹µë‹ˆë‹¤" },
        { name: "êµì£¼", img: "./images/intro4.webp", text: "(â€¦â€¦?)" }
    ];

    const ending1Story = [
        { name: "ë¦´ë¦¬", img: "./images/intro6.webp", text: "êµì£¼ë‹˜! ë“œë””ì–´ 8ë²ˆì˜ ì°¨ì›ì„ ëª¨ë‘ í™•ì¸í–ˆìŠµë‹ˆë‹¤!" }
    ];
    const ending2Story = [
        { name: "ë¦´ë¦¬", img: "./images/intro3.webp", text: "ì°¨ì›ë¬¸ì„ ê°œë°©í•©ë‹ˆë‹¤!" },
        { name: "êµì£¼", img: "./images/end0.webp", text: "(ì €ê±´â€¦)" },
        { name: "êµì£¼", img: "./images/end0.webp", text: "(ì°¨ì›ë¬¸ ë„ˆë¨¸ë¡œ ì„¸ê³„ìˆ˜ê°€ ë³´ì¸ë‹¤â€¦)" },
        { name: "êµì£¼", img: "./images/end1.webp", text: "(ë³¸ëŠ¥ì ìœ¼ë¡œ ì•Œ ìˆ˜ ìˆë‹¤)" },
        { name: "êµì£¼", img: "./images/end1.webp", text: "(ì €ê³³ì€ ë‚˜ì˜ ì—˜ë¦¬ì•„ìŠ¤ê°€ í‹€ë¦¼ì—†ë‹¤)" },
        { name: "êµì£¼", img: "./images/intro3.webp", text: "(â€¦)" },
        { name: "ë¦´ë¦¬", img: "./images/intro3.webp", text: "ë­˜ ë´ìš”" },
        { name: "êµì£¼", img: "./images/intro3.webp", text: "(ê°™ì´ ê°€ì, ë¦´ë¦¬)" },
        { name: "ë¦´ë¦¬", img: "./images/intro3.webp", text: "â€¦" },
        { name: "ë¦´ë¦¬", img: "./images/intro5.webp", text: "ì•ˆë¼ìš”" },
        { name: "ë¦´ë¦¬", img: "./images/intro5.webp", text: "ì €ëŠ” êµì£¼ë‹˜ ì„¸ê³„ì˜ ì¡´ì¬ê°€ ì•„ë‹ˆì—ìš”" },
        { name: "ë¦´ë¦¬", img: "./images/intro5.webp", text: "ì €ëŠ” ê°€ì§œë¼êµ¬ìš”" },
        { name: "êµì£¼", img: "./images/intro3.webp", text: "â€¦" },
        { name: "êµì£¼", img: "./images/intro3.webp", text: "(ì•„ë‹ˆì•¼)" },
    ];
    const ending3Story = [
        { name: "êµì£¼", img: "./images/intro3.webp", text: "(ë„ˆëŠ” ì§„ì§œì•¼, ë¦´ë¦¬)" },
        { name: "ë¦´ë¦¬", img: "./images/intro3.webp", text: "â€¦êµì£¼ë‹˜â€¦" },
        { name: "ë¦´ë¦¬", img: "./images/intro3.webp", text: "â€¦ì ˆ ìŠì§€ ì•Šìœ¼ì…¨êµ°ìš”â€¦?" },
        { name: "êµì£¼", img: "./images/intro3.webp", text: "ë‹¹ì—°í•˜ì§€ ë¦´ë¦¬" },
        { name: "êµì£¼", img: "./images/intro3.webp", text: "ë‚´ê°€ ì–´ë–»ê²Œ ë„ ìŠê² ì–´ ë¦´ë¦¬!" },
        { name: "ë¦´ë¦¬", img: "./images/intro3.webp", text: "êµì£¼ë‹˜â€¦!" },
        { name: "ë¦´ë¦¬(íë¦¼)", img: "./images/end6.webp", text: "ì—ì‡!" },
        { name: "êµì£¼)", img: "./images/end6.webp", text: "(?!)" },
        { name: "ë¦´ë¦¬(íë¦¼)", img: "./images/end6.webp", text: "êµì£¼ë‹˜" },
        { name: "ë¦´1ë¦¬", img: "./images/end12.webp", text: "ê±°ê¸°ê°€ë©´ ì € ì¸í˜•íƒˆ ì…íˆê³  ì¤˜íŒ° ê±° ì–ì•„ìš”" },
        { name: "ë¦´1ë¦¬", img: "./images/end12.webp", text: "ë„ë¼ë“  ë¯¸ì¹œ ì‚¬ì œì¥í•œí…Œ ì‚¬ì§€ê°€ ì°¢ê¸°ëŠ” ëª¨ìŠµì´ ëˆˆì— ì„ í•˜ë„¤ìš”" },
        { name: "ë¦´1ë¦¬", img: "./images/end12.webp", text: "ì œê°€ ë¯¸ì³¤ë‹¤ê³  ê±°ê¸¸ ì™œ ê°€ìš”" },
        { name: "ë¦´ë¦¬(ë©€ì–´ì ¸ê°)", img: "./images/end7.webp", text: "ë­â€¦ ê·¸ë˜ë„" },
        { name: "ë¦´ë¦¬(ë©€ì–´ì ¸ê°)", img: "./images/end8.webp", text: "ì ì‹œë‚˜ë§ˆ í•¨ê»˜ í•  ìˆ˜ ìˆì–´ì„œ" },
        { name: "ë¦´ë¦¬(ë©€ì–´ì ¸ê°)", img: "./images/end9.webp", text: "ì¢‹ì•˜ì–´ìš”" },
        { name: "ë¦´ë¦¬(ë©€ì–´ì ¸ê°)", img: "./images/end10.webp", text: "ì•ˆë…•â€¦ ìš©ì‚¬ë‹˜â€¦" },
        { name: "ë", img: "./images/end11.webp", text: "[Ending : í‡´ê·¼]" }
    ];
    const ending4Story = [
        { name: "êµì£¼", img: "./images/intro3.webp", text: "(ë„ˆëŠ” ê°€ì§œë‹¤!!!)" },
        { name: "ë¦´ìŠ¤í”¼", img: "./images/end2.webp", text: "ì•„ë‹ˆ ì–´ë–»ê²Œ ì•Œì•˜ì§€?!" },
        { name: "êµì£¼", img: "./images/end3.webp", text: "(ìµìˆ™í•œ ì²œì¥ì´ë‹¤â€¦)" },
        { name: "ì—ìŠ¤í”¼", img: "./images/end4.webp", text: "ííâ€¦ì—­ì‹œ êµì£¼ ê¿ˆì´ ì œì¼ ì¬ë°Œì–´" },
        { name: "êµì£¼", img: "./images/end4.webp", text: "(ì—ìŠ¤í”¼ ë…€ì„â€¦ ì¡°ë§Œê°„ ê°€ë©´ì„ ë°•ì‚´ë‚´ì£¼ë§ˆ!)" },
        { name: "ë", img: "./images/end5.webp", text: "[Ending : 5ì–µë…„ì˜ ê°œê¿ˆ]" } 
    ];

    let currentIntroIndex = 0;
    let typeWriterInterval;
    let isTyping = false;
    let fullIntroText = "";

    window.startIntro = () => {
        currentIntroIndex = 0;
        window.renderIntro();
        window.showScreen('screen-intro');
    };

    window.renderIntro = () => {
        if (currentIntroIndex >= introStory.length) {
            window.skipIntro();
            return;
        }
        const currentScene = introStory[currentIntroIndex];
        
        const imgElement = document.getElementById('intro-image');
        imgElement.classList.remove('fade-in-effect');
        void imgElement.offsetWidth; 
        imgElement.src = currentScene.img;
        imgElement.classList.add('fade-in-effect');

        if (currentScene.name === "ë¦´ë¦¬") {
            const altImageSrc = "./images/lily_scream.webp"; 
            let timeoutId = null;
            imgElement.onclick = () => {
                imgElement.src = altImageSrc;
                if (timeoutId) clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    if (introStory[currentIntroIndex] === currentScene) {
                        imgElement.src = currentScene.img;
                    }
                }, 800); 
            };
        } else {
            imgElement.onclick = null;
        }
        
        document.getElementById('intro-name-overlay').innerText = currentScene.name;
        
        const textElement = document.getElementById('intro-dialogue-text');
        textElement.textContent = ""; 
        fullIntroText = currentScene.text;
        
        if (typeWriterInterval) clearInterval(typeWriterInterval);
        isTyping = true;
        
        let charIndex = 0;
        
        typeWriterInterval = setInterval(() => {
            if (charIndex < fullIntroText.length) {
                textElement.textContent = fullIntroText.substring(0, charIndex + 1);
                charIndex++;
            } else {
                clearInterval(typeWriterInterval);
                isTyping = false;
            }
        }, 40); 
    };

    window.nextIntro = () => {
        if (isTyping) {
            clearInterval(typeWriterInterval);
            document.getElementById('intro-dialogue-text').innerText = fullIntroText;
            isTyping = false;
        } else {
            currentIntroIndex++;
            window.renderIntro();
        }
    };

    window.skipIntro = () => {
        window.resetGame();
    };

    const getInitialConsonant = (str) => {
        const chosung = ["ã„±", "ã„²", "ã„´", "ã„·", "ã„¸", "ã„¹", "ã…", "ã…‚", "ã…ƒ", "ã……", "ã…†", "ã…‡", "ã…ˆ", "ã…‰", "ã…Š", "ã…‹", "ã…Œ", "ã…", "ã…"];
        const charCode = str.charCodeAt(0);
        if (charCode < 44032 || charCode > 55203) return str.charAt(0); 
        let initial = chosung[Math.floor((charCode - 44032) / 588)];
        const groupMap = { "ã„²": "ã„±", "ã„¸": "ã„·", "ã…ƒ": "ã…‚", "ã…†": "ã……", "ã…‰": "ã…ˆ" };
        return groupMap[initial] || initial;
    };

    window.initFilters = () => {
        const filterContainer = document.getElementById('filter-container');
        if (filterContainer.innerHTML !== '') return; 
        const filterList = ['All', 'ã„±', 'ã„´', 'ã„·', 'ã„¹', 'ã…', 'ã…‚', 'ã……', 'ã…‡', 'ã…ˆ', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'];
        
        filterList.forEach(f => {
            const btn = document.createElement('button');
            btn.className = f === 'All' ? 'filter-btn all-btn' : 'filter-btn';
            if (f === 'All') btn.classList.add('active');
            btn.innerText = f === 'All' ? 'ì „ì²´' : f; 
            btn.dataset.filter = f;
            btn.onclick = () => window.renderWaitingChars(f);
            filterContainer.appendChild(btn);
        });
    };

    window.renderWaitingChars = (filterStr) => {
        currentFilter = filterStr;
        const container = document.getElementById('waiting-chars');
        container.innerHTML = '';
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.filter === filterStr) btn.classList.add('active');
        });

        CHARACTERS.forEach(char => {
            if (filterStr !== 'All') {
                const initial = getInitialConsonant(char.name); 
                if (initial !== filterStr) return;
            }
            const div = document.createElement('div');
            const state = playerProgress[char.id] || 'unattempted';
            div.className = `waiting-char ${state}`;
            
            if (state === 'unattempted') div.style.cursor = 'not-allowed';
            
            div.onclick = (e) => {
                if (isDraggingList) { e.preventDefault(); return; }
                if (state === 'unattempted') return;
                window.interactInWaiting(char);
            };
            
            const img = document.createElement('img');
            img.src = char.waitingImg;
            div.appendChild(img);
            container.appendChild(div);
        });
    };

    window.showScreen = (id) => {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('score').innerText = score;
    };

    function preloadImage(url) {
        return new Promise((resolve) => {
            if (!url || url.trim() === "") resolve(false);
            const img = new Image();
            img.src = url;
            img.onload = () => resolve(true);
            img.onerror = () => resolve(false);
        });
    }

    async function loadDataAndStart() {
        try {
            const res = await fetch('./characters.csv');
            const csvText = await res.text();
            Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                complete: async function(results) {
                    const rawData = results.data;
                    let loadedCount = 0;
                    const tempChars = [];
                    for (let row of rawData) {
                        const charObj = {
                            id: row.id, name: row.name, nameq: row.nameq || row.name,
                            isOriginal: row.isOriginal.trim().toLowerCase() === 'true',
                            waitingImg: row.waitingImg, questionImg: row.questionImg,
                            correctImg: row.correctImg, wrongImg: row.wrongImg,
                            winMsg: row.winMsg, loseMsg: row.loseMsg,
                            questionText: row.questionText || "..."
                        };
                        const checks = await Promise.all([
                            preloadImage(charObj.waitingImg), preloadImage(charObj.questionImg),
                            preloadImage(charObj.correctImg), preloadImage(charObj.wrongImg)
                        ]);
                        if (checks.every(s => s)) tempChars.push(charObj);
                        loadedCount++;
                        const percent = Math.round((loadedCount / rawData.length) * 100);
                        document.getElementById('loading-text').innerText = `ë³¼ë”°êµ¬ ê²€ì‚¬ ì¤‘... (${percent}%)`;
                        document.getElementById('loading-bar').style.width = `${percent}%`;
                    }
                    CHARACTERS = tempChars;
                    window.initFilters(); 
                    window.startIntro(); 
                }
            });
        } catch (e) { document.getElementById('loading-text').innerText = "ë°ì´í„° ë¡œë”© ì‹¤íŒ¨"; }
    }

    window.resetGame = () => {
        document.querySelector('.score-board').style.display = 'block';
        score = 0;
        currentRunHistory = [];
        remainingPool = [...CHARACTERS];
        window.enterWaitingRoom();
    };

    window.enterWaitingRoom = () => {
        window.showScreen('screen-waiting');
        window.closeWaitingDetail(); 
        window.renderWaitingChars(currentFilter); 
    };

    window.interactInWaiting = async (char) => {
        currentDetailChar = char;
        document.querySelector('.score-board').style.display = 'none';
        document.getElementById('waiting-header').style.display = 'none';
        document.getElementById('waiting-footer').style.display = 'none';
        document.getElementById('waiting-detail-left').style.display = 'flex';
        document.getElementById('waiting-list-panel').className = 'detail-view';

        const state = playerProgress[char.id] || 'unattempted';
        const statsOverlay = document.getElementById('waiting-stats-overlay');
        statsOverlay.style.display = 'block';
        
        let truthHtml = char.isOriginal 
            ? '<div style="background:#2ecc71; border: 2px solid #27ae60; color:#fff; border-radius:8px; padding:3px; margin-bottom:5px; text-align:center; font-weight:bold; font-size:15px;">\uC9C4\uC9DC</div>' 
            : '<div style="background:#e74c3c; border: 2px solid #c0392b; color:#fff; border-radius:8px; padding:3px; margin-bottom:5px; text-align:center; font-weight:bold; font-size:15px;">\uAC00\uC9DC</div>';

        statsOverlay.innerHTML = truthHtml + '\uB85C\uB529\u0020\uC911\u002E\u002E\u002E'; 
        
        const snap = await getDoc(doc(db, "characters", char.id.toString()));
        if (snap.exists()) {
            const d = snap.data();
            const rate = Math.round((d.wrong / d.total) * 100) || 0;
            currentDetailChar.fetchedRate = rate;
            const colorStyle = rate >= 70 ? 'color: #ff7675;' : 'color: #f1c40f;';
            statsOverlay.innerHTML = truthHtml + '\uC624\uB2F5\uB960\u003A <strong style="' + colorStyle + ' font-size: 16px;">' + rate + '%</strong><br><span style="font-size: 12px; opacity: 0.8;">(ì´ '+d.total+'íšŒ ì°¸ì—¬)</span>';
        } else {
            currentDetailChar.fetchedRate = 0;
            statsOverlay.innerHTML = truthHtml + 'No Data';
        }

        window.changeDetailView('question');
    };

    window.changeDetailView = (viewType) => {
        if (!currentDetailChar) return;
        
        document.getElementById('nav-btn-q').classList.remove('active');
        document.getElementById('nav-btn-o').classList.remove('active');
        document.getElementById('nav-btn-x').classList.remove('active');
        
        const header = document.getElementById('waiting-result-header');
        const img = document.getElementById('waiting-char-image');
        const text = document.getElementById('waiting-dialogue-text');
        const nameOverlay = document.getElementById('waiting-name-overlay');
        
        nameOverlay.style.display = 'block'; 

        if (viewType === 'question') {
            document.getElementById('nav-btn-q').classList.add('active');
            const state = playerProgress[currentDetailChar.id];
            if (state === 'correct') {
                header.innerText = "ë§ì¶˜ ë¬¸ì œì—ìš”"; 
                header.className = "result-title result-correct";
            } else {
                header.innerText = "í‹€ë¦° ë¬¸ì œì—ìš”"; 
                header.className = "result-title result-wrong";
            } 
            img.src = currentDetailChar.questionImg;
            text.innerText = currentDetailChar.questionText;
            nameOverlay.innerText = currentDetailChar.nameq;
        } else if (viewType === 'correct') {
            document.getElementById('nav-btn-o').classList.add('active');
            header.innerText = "ì •ë‹µ í™•ì¸";
            header.className = "result-title result-correct";
            img.src = currentDetailChar.correctImg;
            text.innerText = currentDetailChar.winMsg;
            nameOverlay.innerText = currentDetailChar.name;
        } else if (viewType === 'wrong') {
            document.getElementById('nav-btn-x').classList.add('active');
            header.innerText = "ì˜¤ë‹µ í™•ì¸";
            header.className = "result-title result-wrong";
            img.src = currentDetailChar.wrongImg;
            
            let detailSpeechText = currentDetailChar.loseMsg;
            if (currentDetailChar.name === 'ë®¤íŠ¸') {
                let r = currentDetailChar.fetchedRate || 0;
                detailSpeechText = `êµì£¼ë‹˜ì´ ì´ ë¬¸ì œë¥¼ í‹€ë ¸ì„ í™•ë¥  : ${r}%`;
            }
            text.innerText = detailSpeechText;
            
            if (currentDetailChar.name === 'ë§ˆë¦¬') nameOverlay.style.display = 'none'; 
            else if (currentDetailChar.name === 'ë²„í„°') nameOverlay.innerText = 'ë§ˆë“¤ë Œ'; 
            else nameOverlay.innerText = currentDetailChar.name;
        }
    };

    window.closeWaitingDetail = () => {
        document.querySelector('.score-board').style.display = 'block';
        document.getElementById('waiting-header').style.display = 'flex';
        document.getElementById('waiting-footer').style.display = 'block';
        document.getElementById('waiting-detail-left').style.display = 'none';
        document.getElementById('waiting-list-panel').className = 'full-view';
    };

    window.moveToQuestion = () => {
        if (remainingPool.length === 0) remainingPool = [...CHARACTERS];

        let unattemptedIndices = [];
        for (let i = 0; i < remainingPool.length; i++) {
            if (!playerProgress[remainingPool[i].id]) unattemptedIndices.push(i);
        }

        let idx;
        if (unattemptedIndices.length > 0) {
            let randPos = Math.floor(Math.random() * unattemptedIndices.length);
            idx = unattemptedIndices[randPos];
        } else {
            idx = Math.floor(Math.random() * remainingPool.length);
        }

        currentProblem = remainingPool.splice(idx, 1)[0];
        
        document.getElementById('question-name-overlay').innerText = currentProblem.nameq;
        document.getElementById('question-image').src = currentProblem.questionImg;
        document.getElementById('question-dialogue-text').innerText = currentProblem.questionText;
        window.showScreen('screen-question');
    };

    window.submitAnswer = async (choseReal) => {
        const isCorrect = (choseReal === currentProblem.isOriginal);
        if (isCorrect) {
            window.popConfetti();
            currentRunHistory.push(currentProblem); 
        } else {
            const container = document.getElementById('game-container');
            container.classList.add('shake-effect');
            setTimeout(() => container.classList.remove('shake-effect'), 500);
            currentRunHistory = []; 
        }

        const isFirstAttempt = !playerProgress[currentProblem.id];
        const ref = doc(db, "characters", currentProblem.id.toString());
        
        if (isFirstAttempt) {
            try { await updateDoc(ref, { total: increment(1), wrong: increment(isCorrect ? 0 : 1) }); }
            catch { await setDoc(ref, { total: 1, wrong: isCorrect ? 0 : 1 }); }
        }

        playerProgress[currentProblem.id] = isCorrect ? 'correct' : 'wrong';
        localStorage.setItem('trickcal_progress', JSON.stringify(playerProgress));

        const statsOverlay = document.getElementById('result-stats-overlay');
        statsOverlay.innerHTML = "Loading...";

        const snap = await getDoc(ref);
        let currentRate = 0; 

        if (snap.exists()) {
            const d = snap.data();
            currentRate = Math.round((d.wrong / d.total) * 100) || 0;
            const colorStyle = currentRate >= 70 ? 'color: #ff7675;' : 'color: #f1c40f;';
            statsOverlay.innerHTML = `ì˜¤ë‹µë¥ : <strong style="${colorStyle} font-size: 18px;">${currentRate}%</strong><br><span style="font-size: 13px; opacity: 0.8;">(ì´ ${d.total}íšŒ ì°¸ì—¬)</span>`;
        }

        lastResultStatus = isCorrect;
        score = isCorrect ? score + 1 : 0;

        document.getElementById('result-heading').innerText = isCorrect ? "ì •ë‹µì…ë‹ˆë‹¤!" : "ì˜¤ë‹µì…ë‹ˆë‹¤...";
        document.getElementById('result-heading').className = `result-title ${isCorrect ? 'result-correct' : 'result-wrong'}`;
        
        const resultNameOverlay = document.getElementById('result-name-overlay');
        resultNameOverlay.style.display = 'block';
        
        if (!isCorrect && currentProblem.name === 'ë§ˆë¦¬') resultNameOverlay.style.display = 'none';
        else if (!isCorrect && currentProblem.name === 'ë²„í„°') resultNameOverlay.innerText = 'ë§ˆë“¤ë Œ';
        else resultNameOverlay.innerText = currentProblem.name;
        
        document.getElementById('result-image').src = isCorrect ? currentProblem.correctImg : currentProblem.wrongImg;
        
        let finalSpeechText = isCorrect ? currentProblem.winMsg : currentProblem.loseMsg;
        if (!isCorrect && currentProblem.name === 'ë®¤íŠ¸') {
            finalSpeechText = `êµì£¼ë‹˜ì´ ì´ ë¬¸ì œë¥¼ í‹€ë ¸ì„ í™•ë¥  : ${currentRate}%`;
        }
        document.getElementById('result-speech-text').innerText = finalSpeechText;
        
        window.showScreen('screen-result');
    };

    window.closeResultAndMove = () => {
        if (lastResultStatus && score >= 8) window.startEnding();
        else window.enterWaitingRoom();
    };

    let endingPhase = 0; 
    let endingStoryIndex = 0;
    let isEndingTyping = false;
    let endingTypeWriterInterval;
    let fullEndingText = "";
    let endingChoiceReal = true;
    let endingStatsPercent = 0;

    window.startEnding = () => {
        document.querySelector('.score-board').style.display = 'none'; 
        endingPhase = 0;
        endingStoryIndex = 0;
        window.showScreen('screen-ending');
        window.renderEndingPhase();
    };

    window.renderEndingPhase = () => {
        const singleImg = document.getElementById('ending-single-image');
        const slideContainer = document.getElementById('ending-slide-container');
        const nameOverlay = document.getElementById('ending-name-overlay');
        const textElement = document.getElementById('ending-dialogue-text');
        const nextBtn = document.getElementById('ending-btn-next-container');
        const choiceBtn = document.getElementById('ending-btn-choice-container');

        singleImg.style.display = 'block';
        singleImg.classList.remove('fade-in-effect');
        void singleImg.offsetWidth; 
        singleImg.classList.add('fade-in-effect');
        
        slideContainer.style.display = 'none';
        nextBtn.style.display = 'flex';
        choiceBtn.style.display = 'none';
        nameOverlay.style.display = 'block';

        let currentStoryData = null;

        if (endingPhase === 0) {
            if (endingStoryIndex >= ending1Story.length) {
                endingPhase = 1;
                window.renderEndingPhase();
                return;
            }
            currentStoryData = ending1Story[endingStoryIndex];
        } else if (endingPhase === 1) {
            singleImg.style.display = 'none';
            slideContainer.style.display = 'flex';
            renderSlidingChars(currentRunHistory.filter(c => c.isOriginal));
            nameOverlay.innerText = "ë¦´ë¦¬(ì„¤ëª…)";
            fullEndingText = "êµì£¼ë‹˜ê»˜ì„œ ë§Œë‚œ 'ì§„ì§œ' ì‚¬ë„ë“¤ì˜ ê¸°ë¡ì…ë‹ˆë‹¤";
            playEndingTyping(textElement, fullEndingText);
            return;
        } else if (endingPhase === 2) {
            singleImg.style.display = 'none';
            slideContainer.style.display = 'flex';
            renderSlidingChars(currentRunHistory.filter(c => !c.isOriginal));
            nameOverlay.innerText = "ë¦´ë¦¬(ì„¤ëª…)";
            fullEndingText = "êµì£¼ë‹˜ê»˜ì„œ ë§Œë‚œ 'ê°€ì§œ' ì‚¬ë„ë“¤ì˜ ê¸°ë¡ì…ë‹ˆë‹¤";
            playEndingTyping(textElement, fullEndingText);
            return;
        } else if (endingPhase === 3) {
            singleImg.style.display = 'none';
            slideContainer.style.display = 'flex';
            renderSlidingChars(currentRunHistory);
            nameOverlay.innerText = "ë¦´ë¦¬(ì„¤ëª…)";
            fullEndingText = "ì´ ê¸°ë¡ë“¤ì„ ê¸°ë°˜ìœ¼ë¡œ ì°¨ì› ë¶„ì„ì„ ë§ˆì³¤ì–´ìš”";
            playEndingTyping(textElement, fullEndingText);
            return;
        } else if (endingPhase === 4) {
            if (endingStoryIndex >= ending2Story.length) {
                endingPhase = 5;
                window.renderEndingPhase();
                return;
            }
            currentStoryData = ending2Story[endingStoryIndex];
        } else if (endingPhase === 5) {
            singleImg.src = "./images/intro3.webp"; 
            nameOverlay.innerText = "êµì£¼";
            fullEndingText = "(ì•„ë‹ˆì•¼â€¦! ë„ˆëŠ”â€¦!)";
            nextBtn.style.display = 'none';
            choiceBtn.style.display = 'flex';
            singleImg.onclick = null; // ì„ íƒì§€ ì”¬ì—ì„œëŠ” í„°ì¹˜ ì´ë²¤íŠ¸ ì™„ì „ í•´ì œ
            playEndingTyping(textElement, fullEndingText);
            return;
        } else if (endingPhase === 6) {
            const storyArr = endingChoiceReal ? ending3Story : ending4Story;
            if (endingStoryIndex >= storyArr.length) {
                window.showScreen('screen-thanks');
                return;
            }
            currentStoryData = storyArr[endingStoryIndex];
            
            // ë§ˆì§€ë§‰ ëŒ€ì‚¬ì¼ ê²½ìš° í†µê³„ í…ìŠ¤íŠ¸ ê²°í•©
            if (endingStoryIndex === storyArr.length - 1) {
                fullEndingText = currentStoryData.text + `\n\n[ë‹¹ì‹ ê³¼ ê°™ì€ ê²°ì •ì„ ë‚´ë¦° êµì£¼ì˜ ë¹„ìœ¨: ${endingStatsPercent}%]`;
            } else {
                fullEndingText = currentStoryData.text;
            }
        }

        if (currentStoryData) {
            singleImg.src = currentStoryData.img;
            nameOverlay.innerText = currentStoryData.name;
            
            // Phase 6ì´ ì•„ë‹ ë•Œë§Œ í…ìŠ¤íŠ¸ ë®ì–´ì“°ê¸° (Phase 6ì€ ìœ„ì—ì„œ í†µê³„ í…ìŠ¤íŠ¸ë¥¼ ì¤€ë¹„í–ˆìœ¼ë¯€ë¡œ)
            if (endingPhase !== 6) {
                fullEndingText = currentStoryData.text;
            }
            playEndingTyping(textElement, fullEndingText);

            // ---- ë¦´ë¦¬ í„°ì¹˜ ì´ìŠ¤í„°ì—ê·¸ ë¡œì§ ----
            if (currentStoryData.name === "ë¦´ë¦¬") {
                const altImageSrc = "./images/lily_scream.webp"; 
                let timeoutId = null;
                const currentPhase = endingPhase;
                const currentIndex = endingStoryIndex;

                singleImg.onclick = () => {
                    singleImg.src = altImageSrc;
                    if (timeoutId) clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => {
                        // ì‚¬ìš©ìê°€ ë‹¤ìŒ í™”ë©´ìœ¼ë¡œ ë„˜ì–´ê°€ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ í™”ë©´ì— ë¨¸ë¬¼ëŸ¬ ìˆì„ ë•Œë§Œ ì›ë˜ ì´ë¯¸ì§€ë¡œ ë³µêµ¬
                        if (endingPhase === currentPhase && endingStoryIndex === currentIndex) {
                            singleImg.src = currentStoryData.img;
                        }
                    }, 800); 
                };
            } else {
                // ë¦´ë¦¬ê°€ ì•„ë‹ ë•ŒëŠ” ë¬´ì¡°ê±´ í´ë¦­ ì´ë²¤íŠ¸ í•´ì œ
                singleImg.onclick = null; 
            }
        }
    };

function renderSlidingChars(chars) {
        const container = document.getElementById('ending-slide-container');
        const track = document.getElementById('ending-slide-track');
        track.innerHTML = '';
        
        if (chars.length === 0) {
            track.innerHTML = '<span style="color:#7f8c8d; font-size:24px; margin:auto;">(í•´ë‹¹ ê¸°ë¡ ì—†ìŒ)</span>';
            track.style.animation = 'none';
            track.style.width = '100%';
            track.style.justifyContent = 'center';
            return;
        }

        track.style.justifyContent = 'flex-start';
        track.style.width = 'max-content';
        
        // ìºë¦­í„° ìƒì(ì´ë¯¸ì§€ + ì´ë¦„) ìƒì„±
        chars.forEach((char) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'slide-item';
            
            const img = document.createElement('img');
            img.src = char.questionImg;
            
            // ì´ë¦„í‘œ ìƒì„±
            const nameDiv = document.createElement('div');
            nameDiv.className = 'name-overlay';
            nameDiv.style.fontSize = '14px'; // ì‘ì€ ë°•ìŠ¤ì— ë§ì¶° ê¸€ì í¬ê¸° ì¶•ì†Œ
            nameDiv.style.padding = '4px 8px';
            nameDiv.style.top = '5px';
            nameDiv.style.left = '5px';
            nameDiv.innerText = char.name; // CSVì˜ name ê°€ì ¸ì˜¤ê¸°
            
            wrapper.appendChild(img);
            wrapper.appendChild(nameDiv);
            track.appendChild(wrapper);
        });

        const containerWidth = container.clientWidth || 900;
        
        setTimeout(() => {
            const trackWidth = track.scrollWidth;
            
            let styleEl = document.getElementById('dynamic-marquee-style');
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = 'dynamic-marquee-style';
                document.head.appendChild(styleEl);
            }
            
            const totalDistance = containerWidth + trackWidth;
            
            styleEl.innerHTML = `
                @keyframes dynamicSlideShow {
                    0% { transform: translateX(${containerWidth}px); }
                    100% { transform: translateX(-${trackWidth}px); }
                }
            `;

            // ìŠ¤í¬ë¡¤ ì†ë„ ì¡°ì ˆ (ì´ˆë‹¹ 150í”½ì…€ ì´ë™)
            const speedPerSecond = 150; 
            const duration = totalDistance / speedPerSecond; 
            
            track.style.animation = 'none';
            void track.offsetWidth;
            track.style.animation = `dynamicSlideShow ${duration}s linear infinite`;
        }, 50);
    }

    function playEndingTyping(element, text) {
        element.textContent = "";
        if (endingTypeWriterInterval) clearInterval(endingTypeWriterInterval);
        isEndingTyping = true;
        let charIndex = 0;
        endingTypeWriterInterval = setInterval(() => {
            if (charIndex < text.length) {
                element.textContent = text.substring(0, charIndex + 1);
                charIndex++;
            } else {
                clearInterval(endingTypeWriterInterval);
                isEndingTyping = false;
            }
        }, 40);
    }

    window.nextEnding = () => {
        if (isEndingTyping) {
            clearInterval(endingTypeWriterInterval);
            document.getElementById('ending-dialogue-text').innerText = fullEndingText;
            isEndingTyping = false;
        } else {
            if (endingPhase === 0 || endingPhase === 4 || endingPhase === 6) {
                endingStoryIndex++;
            } else if (endingPhase >= 1 && endingPhase <= 3) {
                endingPhase++;
                endingStoryIndex = 0;
            }
            window.renderEndingPhase();
        }
    };

    window.chooseEnding = async (isReal) => {
        endingChoiceReal = isReal;
        
        const choiceBtnContainer = document.getElementById('ending-btn-choice-container');
        choiceBtnContainer.style.pointerEvents = 'none';
        choiceBtnContainer.style.opacity = '0.5';
        document.getElementById('ending-dialogue-text').innerText = "ê²°ê³¼ë¥¼ ì°¨ì› ì„œë²„ì— ê¸°ë¡ ì¤‘ì…ë‹ˆë‹¤...";

        endingStatsPercent = await recordAndFetchEndingStats(isReal);
        
        endingPhase = 6;
        endingStoryIndex = 0;
        
        choiceBtnContainer.style.pointerEvents = 'auto';
        choiceBtnContainer.style.opacity = '1';
        window.renderEndingPhase();
    };

    async function recordAndFetchEndingStats(isReal) {
        const hasCleared = localStorage.getItem('trickcal_ending_cleared');
        const statRef = doc(db, "system", "ending_stats");
        let percent = 100;

        try {
            if (!hasCleared) {
                try {
                    await updateDoc(statRef, {
                        [isReal ? 'real_count' : 'fake_count']: increment(1)
                    });
                } catch (e) {
                    await setDoc(statRef, {
                        real_count: isReal ? 1 : 0,
                        fake_count: isReal ? 0 : 1
                    });
                }
                localStorage.setItem('trickcal_ending_cleared', 'true');
            }

            const snap = await getDoc(statRef);
            if (snap.exists()) {
                const d = snap.data();
                const total = (d.real_count || 0) + (d.fake_count || 0);
                if (total > 0) {
                    const count = isReal ? (d.real_count || 0) : (d.fake_count || 0);
                    percent = Math.round((count / total) * 100);
                }
            }
        } catch(error) {
            console.error("Firebase error: ", error);
        }
        return percent;
    }

    const scrollArea = document.getElementById('waiting-list-panel');
    let isDown = false;
    let startY;
    let scrollTop;

    scrollArea.addEventListener('mousedown', (e) => {
        if (scrollArea.className === 'full-view') return; 
        isDown = true;
        isDraggingList = false; 
        startY = e.pageY - scrollArea.offsetTop;
        scrollTop = scrollArea.scrollTop;
    });
    scrollArea.addEventListener('mouseleave', () => { isDown = false; });
    scrollArea.addEventListener('mouseup', () => {
        isDown = false;
        setTimeout(() => isDraggingList = false, 50); 
    });
    scrollArea.addEventListener('mousemove', (e) => {
        if (!isDown) return;
        e.preventDefault();
        const y = e.pageY - scrollArea.offsetTop;
        const walk = (y - startY) * 1.5; 
        
        if (Math.abs(walk) > 5) isDraggingList = true; 
        scrollArea.scrollTop = scrollTop - walk;
    });

    loadDataAndStart();
</script>
</body>
</html>